/*
 * File:   motor_driver.c
 * Author: Cecil
 *
 * Created on June 14, 2018, 5:32 PM
 */


#include "xc.h"
#pragma config FNOSC = FRCPLL
#pragma config FWDTEN = 0b00
#define FCY   16000000UL
#include <libpic30.h>


int amp, switch_state, old_switch_state;
int N = 1;
static int i = 1, j = 1, k = 0;


//The arrays here are generated by sampling the desired signal 
//with an amplitude of one volt at 10,000 Hz.  any array can be
//re populated with a new desired signal simple adjusting N to
//match the number of data points in the new sample.

unsigned int array[200] = {
    0
};

const unsigned int zero_hz[50] = {
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0
};

const unsigned int fifty_hz[200] = {
    243,
    251,
    258,
    266,
    273,
    281,
    289,
    296,
    303,
    311,
    318,
    325,
    332,
    340,
    346,
    353,
    360,
    367,
    373,
    380,
    386,
    392,
    398,
    404,
    409,
    415,
    420,
    425,
    430,
    435,
    440,
    444,
    448,
    452,
    456,
    460,
    463,
    466,
    469,
    472,
    474,
    476,
    478,
    480,
    482,
    483,
    484,
    485,
    486,
    486,
    486,
    486,
    486,
    485,
    484,
    483,
    482,
    480,
    478,
    476,
    474,
    472,
    469,
    466,
    463,
    460,
    456,
    452,
    448,
    444,
    440,
    435,
    430,
    425,
    420,
    415,
    409,
    404,
    398,
    392,
    386,
    380,
    373,
    367,
    360,
    353,
    346,
    340,
    332,
    325,
    318,
    311,
    303,
    296,
    289,
    281,
    273,
    266,
    258,
    251,
    243,
    235,
    228,
    220,
    213,
    205,
    197,
    190,
    183,
    175,
    168,
    161,
    154,
    146,
    140,
    133,
    126,
    119,
    113,
    106,
    100,
    94,
    88,
    82,
    77,
    71,
    66,
    61,
    56,
    51,
    46,
    42,
    38,
    34,
    30,
    26,
    23,
    20,
    17,
    14,
    12,
    10,
    8,
    6,
    4,
    3,
    2,
    1,
    0,
    0,
    0,
    0,
    0,
    1,
    2,
    3,
    4,
    6,
    8,
    10,
    12,
    14,
    17,
    20,
    23,
    26,
    30,
    34,
    38,
    42,
    46,
    51,
    56,
    61,
    66,
    71,
    77,
    82,
    88,
    94,
    100,
    106,
    113,
    119,
    126,
    133,
    140,
    146,
    154,
    161,
    168,
    175,
    183,
    190,
    197,
    205,
    213,
    220,
    228,
    235
};

const unsigned int sixty_hz[167] = {
    243,
    252,
    261,
    270,
    280,
    289,
    297,
    306,
    315,
    324,
    332,
    341,
    349,
    357,
    365,
    373,
    381,
    388,
    396,
    403,
    409,
    416,
    422,
    428,
    434,
    440,
    445,
    450,
    454,
    459,
    463,
    467,
    470,
    473,
    476,
    478,
    480,
    482,
    484,
    485,
    486,
    486,
    486,
    486,
    485,
    484,
    483,
    481,
    479,
    477,
    474,
    471,
    468,
    464,
    460,
    456,
    451,
    447,
    441,
    436,
    430,
    424,
    418,
    412,
    405,
    398,
    391,
    383,
    376,
    368,
    360,
    352,
    344,
    335,
    327,
    318,
    309,
    300,
    292,
    283,
    273,
    264,
    255,
    246,
    237,
    228,
    219,
    210,
    200,
    191,
    183,
    174,
    165,
    156,
    148,
    140,
    131,
    123,
    115,
    108,
    100,
    93,
    86,
    79,
    72,
    66,
    60,
    54,
    48,
    43,
    38,
    33,
    29,
    24,
    21,
    17,
    14,
    11,
    8,
    6,
    4,
    3,
    2,
    1,
    0,
    0,
    0,
    1,
    2,
    3,
    4,
    6,
    8,
    11,
    14,
    17,
    21,
    24,
    29,
    33,
    38,
    43,
    48,
    54,
    60,
    66,
    72,
    79,
    86,
    93,
    100,
    108,
    115,
    123,
    131,
    140,
    148,
    156,
    165,
    174,
    183,
    191,
    200,
    210,
    219,
    228,
    237
};

const unsigned int seventy_hz[143] = {
    243,
    254,
    264,
    275,
    286,
    296,
    306,
    317,
    327,
    337,
    346,
    356,
    365,
    374,
    383,
    392,
    400,
    408,
    416,
    423,
    430,
    437,
    443,
    449,
    454,
    460,
    464,
    468,
    472,
    475,
    478,
    481,
    483,
    484,
    485,
    486,
    486,
    486,
    485,
    483,
    482,
    479,
    477,
    474,
    470,
    466,
    462,
    457,
    451,
    446,
    440,
    433,
    426,
    419,
    412,
    404,
    396,
    387,
    378,
    369,
    360,
    351,
    341,
    331,
    321,
    311,
    300,
    290,
    280,
    269,
    258,
    248,
    237,
    226,
    216,
    205,
    194,
    184,
    174,
    164,
    154,
    144,
    134,
    125,
    115,
    106,
    98,
    89,
    81,
    73,
    66,
    59,
    52,
    46,
    39,
    34,
    29,
    24,
    19,
    15,
    12,
    9,
    6,
    4,
    2,
    1,
    0,
    0,
    0,
    1,
    2,
    3,
    6,
    8,
    11,
    14,
    18,
    22,
    27,
    32,
    38,
    44,
    50,
    57,
    64,
    71,
    79,
    87,
    95,
    104,
    113,
    122,
    131,
    141,
    151,
    161,
    171,
    181,
    191,
    202,
    213,
    223,
    234
};

const unsigned int eighty_hz[126] = {
    243,
    255,
    267,
    280,
    292,
    303,
    315,
    327,
    338,
    349,
    360,
    371,
    381,
    391,
    400,
    409,
    418,
    426,
    434,
    441,
    448,
    454,
    460,
    465,
    470,
    474,
    478,
    480,
    483,
    484,
    486,
    486,
    486,
    485,
    484,
    482,
    479,
    476,
    472,
    468,
    463,
    457,
    451,
    445,
    438,
    430,
    422,
    414,
    405,
    396,
    386,
    376,
    365,
    355,
    344,
    332,
    321,
    309,
    297,
    286,
    273,
    261,
    249,
    237,
    225,
    213,
    200,
    189,
    177,
    165,
    154,
    142,
    131,
    121,
    110,
    100,
    90,
    81,
    72,
    64,
    56,
    48,
    41,
    35,
    29,
    23,
    18,
    14,
    10,
    7,
    4,
    2,
    1,
    0,
    0,
    0,
    2,
    3,
    6,
    8,
    12,
    16,
    21,
    26,
    32,
    38,
    45,
    52,
    60,
    68,
    77,
    86,
    95,
    105,
    115,
    126,
    137,
    148,
    159,
    171,
    183,
    194,
    206,
    219,
    231,
    243
};

const unsigned int ninety_hz[112] = {
    243,
    257,
    270,
    284,
    297,
    311,
    324,
    337,
    349,
    361,
    373,
    385,
    396,
    406,
    416,
    425,
    434,
    442,
    450,
    457,
    463,
    468,
    473,
    477,
    480,
    483,
    485,
    486,
    486,
    485,
    484,
    482,
    479,
    475,
    471,
    466,
    460,
    454,
    447,
    439,
    430,
    421,
    412,
    401,
    391,
    380,
    368,
    356,
    344,
    331,
    318,
    305,
    292,
    278,
    264,
    251,
    237,
    223,
    210,
    196,
    183,
    169,
    156,
    144,
    131,
    119,
    108,
    96,
    86,
    76,
    66,
    57,
    48,
    40,
    33,
    26,
    21,
    15,
    11,
    7,
    4,
    2,
    1,
    0,
    0,
    1,
    3,
    5,
    8,
    12,
    17,
    22,
    29,
    35,
    43,
    51,
    60,
    69,
    79,
    89,
    100,
    112,
    123,
    135,
    148,
    161,
    174,
    187,
    200,
    214,
    228,
    241
};

const unsigned int one_hundred_hz[101] = {
    243,
    258,
    273,
    289,
    303,
    318,
    332,
    346,
    360,
    373,
    386,
    398,
    409,
    420,
    430,
    440,
    448,
    456,
    463,
    469,
    474,
    478,
    482,
    484,
    486,
    486,
    486,
    484,
    482,
    478,
    474,
    469,
    463,
    456,
    448,
    440,
    430,
    420,
    409,
    398,
    386,
    373,
    360,
    346,
    332,
    318,
    303,
    289,
    273,
    258,
    243,
    228,
    213,
    197,
    183,
    168,
    154,
    140,
    126,
    113,
    100,
    88,
    77,
    66,
    56,
    46,
    38,
    30,
    23,
    17,
    12,
    8,
    4,
    2,
    0,
    0,
    0,
    2,
    4,
    8,
    12,
    17,
    23,
    30,
    38,
    46,
    56,
    66,
    77,
    88,
    100,
    113,
    126,
    140,
    154,
    168,
    183,
    197,
    213,
    228,
    243
};

const unsigned int one_ten_hz[91] = {
    243,
    260,
    276,
    293,
    309,
    325,
    341,
    356,
    371,
    385,
    398,
    410,
    422,
    433,
    443,
    452,
    460,
    467,
    473,
    478,
    482,
    484,
    486,
    486,
    485,
    483,
    480,
    475,
    470,
    464,
    456,
    447,
    438,
    427,
    416,
    404,
    391,
    377,
    363,
    348,
    332,
    317,
    300,
    284,
    267,
    251,
    234,
    217,
    200,
    184,
    168,
    152,
    137,
    122,
    108,
    94,
    81,
    69,
    58,
    47,
    38,
    29,
    22,
    15,
    10,
    6,
    3,
    1,
    0,
    0,
    2,
    5,
    8,
    13,
    19,
    26,
    35,
    44,
    54,
    65,
    77,
    89,
    103,
    117,
    131,
    146,
    162,
    178,
    194,
    211,
    228
};

const unsigned int one_twenty_hz[84] = {
    243,
    261,
    280,
    297,
    315,
    332,
    349,
    365,
    381,
    396,
    409,
    422,
    434,
    445,
    454,
    463,
    470,
    476,
    480,
    484,
    486,
    486,
    485,
    483,
    479,
    474,
    468,
    460,
    451,
    441,
    430,
    418,
    405,
    391,
    376,
    360,
    344,
    327,
    309,
    292,
    273,
    255,
    237,
    219,
    200,
    183,
    165,
    148,
    131,
    115,
    100,
    86,
    72,
    60,
    48,
    38,
    29,
    21,
    14,
    8,
    4,
    2,
    0,
    0,
    2,
    4,
    8,
    14,
    21,
    29,
    38,
    48,
    60,
    72,
    86,
    100,
    115,
    131,
    148,
    165,
    183,
    200,
    219,
    237
};

void _ISR _OC1Interrupt(void) {
    _OC1IF = 0;
    OC1R = amp * array[i];
    i++;
    if (i == N)
        i = 0;
}

void _ISR _CNInterrupt(void) {

    __delay_ms(50)

    _CNIF = 0;
    if (_RB13 == 0) {
        switch_state = _RB12;
        //check if switch was changed
        if (switch_state != old_switch_state) {
            if (_RB12 == 1) //if switch is high amplitude is 2 volts
                amp = 2;
            else //else if switch is low amplitude is 1 volt
                amp = 1;

            old_switch_state = _RB12; //save switch position
        }
            //else button was pressed so change frequency
        else {
            if (j == 0) {
                N = 50;
                for (k = 0; k < N; k++)
                    array[k] = zero_hz[k];
            } else if (j == 1) {
                N = 200;
                for (k = 0; k < N; k++)
                    array[k] = fifty_hz[k];
            }
            else if (j == 2) {
                N = 167;
                for (k = 0; k < N; k++)
                    array[k] = sixty_hz[k];
            }
            else if (j == 3) {
                N = 143;
                for (k = 0; k < N; k++)
                    array[k] = seventy_hz[k];
            }
            else if (j == 4) {
                N = 126;
                for (k = 0; k < N; k++)
                    array[k] = eighty_hz[k];
            }
            else if (j == 5) {
                N = 112;
                for (k = 0; k < N; k++)
                    array[k] = ninety_hz[k];
            }
            else if (j == 6) {
                N = 101;
                for (k = 0; k < N; k++)
                    array[k] = one_hundred_hz[k];
            }
            else if (j == 7) {
                N = 91;
                for (k = 0; k < N; k++)
                    array[k] = one_ten_hz[k];
            } else if (j == 8) {
                N = 84;
                for (k = 0; k < N; k++)
                    array[k] = one_twenty_hz[k];
            }

            j++;
            if (j >= 9) //reset once set to highest frequency
            {
                j = 0;
            }
            i = 0;

        }
    }

}

int main(void) {
    //configure input pins
    _TRISB12 = 1;
    _TRISB13 = 1;
    _ANSB12 = 0;
    _ANSB13 = 0;

    //configure change notification on pins 15 and 16
    _CN14IE = 1;
    _CN13IE = 1;
    _CNIF = 0;
    _CNIP = 4;
    _CNIE = 1;

    //PWM configuration
    _RCDIV = 0b00;

    OC1RS = 1600;
    OC1R = array[0];
    OC1CON2bits.SYNCSEL = 0x1f;
    OC1CON2bits.OCTRIG = 0;
    OC1CON1bits.OCTSEL = 7;
    _OC1IP = 3;
    _OC1IF = 0;
    _OC1IE = 1;
    OC1CON1bits.OCM = 6;

    RCONbits.SWDTEN = 0;



    switch_state = _RB12;
    old_switch_state = switch_state;
    if (switch_state == 1) {
        amp = 2;
    } else {
        amp = 1;
    }


    while (1);

    return 0;
}
